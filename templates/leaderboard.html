<!DOCTYPE html>
<html>
<head>
    <title>Leaderboard - Flashcards</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style-index.css') }}">
    <style>
        /* Unique styles for this page only */
        .leaderboard-table {
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .leaderboard-table th, .leaderboard-table td {
            vertical-align: middle;
        }
        .rank-badge {
            font-weight: bold;
            font-size: 1.2em;
        }
        .username-link {
            text-decoration: none;
            color: #0d6efd;
        }
        .username-link:hover {
            text-decoration: underline;
        }
        .sort-btn {
            border: none;
            background: none;
            color: #0d6efd;
            font-weight: bold;
            cursor: pointer;
            padding: 0 4px;
        }
        .sort-btn.active {
            text-decoration: underline;
        }
        .sort-arrow {
            font-size: 0.9em;
        }
        footer {
            margin-top: 40px;
            padding: 10px 0;
        }
        @media (max-width: 768px) {
            .container {
                padding-left: 4px;
                padding-right: 4px;
            }
            .leaderboard-table th, .leaderboard-table td {
                font-size: 1em;
                padding: 8px 4px;
            }
            .rank-badge {
                font-size: 1em;
            }
            h1 {
                font-size: 1.5rem;
            }
        }
        @media (max-width: 576px) {
            .leaderboard-table th, .leaderboard-table td {
                font-size: 0.95em;
                padding: 6px 2px;
            }
            .rank-badge {
                font-size: 0.95em;
            }
            .table-responsive {
                font-size: 0.95em;
            }
        }
        #module-pills-container {
            scrollbar-width: thin;
            scrollbar-color: #0d6efd #e9ecef;
            padding-bottom: 4px;
        }
        #module-pills-container::-webkit-scrollbar {
            height: 6px;
        }
        #module-pills-container::-webkit-scrollbar-thumb {
            background: #0d6efd;
            border-radius: 4px;
        }
        .module-pill.active, .module-pill:active, .module-pill:focus {
            background-color: #0d6efd !important;
            color: #fff !important;
            border-color: #0d6efd !important;
        }
        .navbar-nav .nav-link {
            border-radius: 999px !important;
            padding: 8px 22px !important;
            margin-left: 6px;
            margin-right: 6px;
            font-weight: 600;
            transition: background 0.15s, color 0.15s, box-shadow 0.15s, transform 0.15s;
            background: #f8f9fa !important;
            color: #444 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            position: relative;
            z-index: 1;
        }
        .navbar-nav .nav-link:hover, .navbar-nav .nav-link:focus {
            background: #e2e6ea !important;
            color: #222 !important;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transform: scale(1.04);
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
            <div class="container-fluid">
                <span class="navbar-brand">Flashcards</span>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="{{ url_for('main.index') }}">Back to Flashcards</a>
                    {% if session.user_id %}
                        <a class="nav-link" href="{{ url_for('user.stats') }}">My Stats</a>
                        <a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a>
                    {% else %}
                        <a class="nav-link" href="{{ url_for('auth.login') }}">Login with Discord</a>
                    {% endif %}
                </div>
            </div>
        </nav>
        <h1 class="text-center mb-4">Leaderboard</h1>
        <!-- Module filter using shared component -->
        <div class="row mb-4">
            <div class="col-12 col-md-4">
                {% include 'components/module_selector.html' with context %}
            </div>
        </div>
        <div class="table-responsive">
            <table class="table leaderboard-table table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Rank</th>
                        <th>User</th>
                        <th>
                            <button class="sort-btn {% if sort == 'correct_answers' %}active{% endif %}" data-sort="correct_answers">
                                Correct
                                {% if sort == 'correct_answers' %}
                                <span class="sort-arrow">{% if order == 'desc' %}▼{% else %}▲{% endif %}</span>
                                {% endif %}
                            </button>
                        </th>
                        <th>
                            <button class="sort-btn {% if sort == 'total_answers' %}active{% endif %}" data-sort="total_answers">
                                Total
                                {% if sort == 'total_answers' %}
                                <span class="sort-arrow">{% if order == 'desc' %}▼{% else %}▲{% endif %}</span>
                                {% endif %}
                            </button>
                        </th>
                        <th>
                            <button class="sort-btn {% if sort == 'accuracy' %}active{% endif %}" data-sort="accuracy">
                                Accuracy
                                {% if sort == 'accuracy' %}
                                <span class="sort-arrow">{% if order == 'desc' %}▼{% else %}▲{% endif %}</span>
                                {% endif %}
                            </button>
                        </th>
                        <th>
                            <button class="sort-btn {% if sort == 'current_streak' %}active{% endif %}" data-sort="current_streak">
                                Streak
                                {% if sort == 'current_streak' %}
                                <span class="sort-arrow">{% if order == 'desc' %}▼{% else %}▲{% endif %}</span>
                                {% endif %}
                            </button>
                        </th>
                        <th>
                            <button class="sort-btn {% if sort == 'approved_cards' %}active{% endif %}" data-sort="approved_cards">
                                Approved Cards
                                {% if sort == 'approved_cards' %}
                                <span class="sort-arrow">{% if order == 'desc' %}▼{% else %}▲{% endif %}</span>
                                {% endif %}
                            </button>
                        </th>
                        <th>
                            <button class="sort-btn {% if sort == 'last_answer_time' %}active{% endif %}" data-sort="last_answer_time">
                                Last Active
                                {% if sort == 'last_answer_time' %}
                                <span class="sort-arrow">{% if order == 'desc' %}▼{% else %}▲{% endif %}</span>
                                {% endif %}
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in leaderboard %}
                    <tr>
                        <td class="rank-badge">{{ loop.index }}</td>
                        <td><a href="{{ url_for('user.user_stats', user_id=user.user_id) }}" class="username-link">{{ user.username }}</a></td>
                        <td>{{ user.correct_answers }}</td>
                        <td>{{ user.total_answers }}</td>
                        <td>{{ (user.accuracy * 100) | round(1) }}%</td>
                        <td>{{ user.current_streak }}</td>
                        <td>{{ user.approved_cards }}</td>
                        <td><span class="last-answered" data-timestamp="{{ user.last_answer_time }}"></span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <footer class="text-center">
            <p>made with ❤️ by <a href="https://github.com/joshua-wilcox">Josh Wilcox</a></p>
        </footer>
    </div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='javascript/module-selector.js') }}"></script>
<script>
function formatRelativeTime(ts) {
    if (!ts) return "Never";
    const now = Math.floor((new Date()).getTime() / 1000);
    let diff = now - ts;
    if (diff < 60) return "Just now";
    const units = [
        { name: "year",   secs: 31536000 },
        { name: "month",  secs: 2592000 },
        { name: "day",    secs: 86400 },
        { name: "hour",   secs: 3600 },
        { name: "minute", secs: 60 }
    ];
    for (const unit of units) {
        if (diff >= unit.secs) {
            const value = Math.floor(diff / unit.secs);
            if (window.Intl && Intl.RelativeTimeFormat) {
                const rtf = new Intl.RelativeTimeFormat('en', { numeric: 'auto' });
                return rtf.format(-value, unit.name);
            } else {
                return value + ' ' + unit.name + (value !== 1 ? 's' : '') + ' ago';
            }
        }
    }
    return "Just now";
}

document.addEventListener("DOMContentLoaded", function() {
    // Initialize module selector component
    const moduleSelector = new ModuleSelector({
        containerId: 'module-selector',
        selectedModule: '{{ active_module or "" }}',
        allowDeselect: true,
        onModuleChange: function(selectedModule) {
            const url = new URL(window.location.href);
            
            // Preserve current sorting
            const currentSort = url.searchParams.get('sort');
            const currentOrder = url.searchParams.get('order');
            
            // Clear all parameters and set new ones
            url.search = '';
            
            if (selectedModule) {
                url.searchParams.set('module', selectedModule);
            }
            
            if (currentSort) {
                url.searchParams.set('sort', currentSort);
            }
            
            if (currentOrder) {
                url.searchParams.set('order', currentOrder);
            }
            
            window.location.href = url.toString();
        }
    });

    // Handle formatting for last-answered timestamps
    document.querySelectorAll('.last-answered').forEach(function(el) {
        const ts = el.getAttribute('data-timestamp');
        if (ts && !isNaN(ts)) {
            el.textContent = formatRelativeTime(Number(ts));
        } else {
            el.textContent = "Never";
        }
    });
    
    // Handle sorting buttons click
    document.querySelectorAll('.sort-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const sortBy = btn.getAttribute('data-sort');
            const url = new URL(window.location.href);
            
            // If already sorting by this column, toggle the order
            if (url.searchParams.get('sort') === sortBy) {
                const currentOrder = url.searchParams.get('order') || 'desc';
                url.searchParams.set('order', currentOrder === 'desc' ? 'asc' : 'desc');
            } else {
                // New sort column, default to descending order
                url.searchParams.set('sort', sortBy);
                url.searchParams.set('order', 'desc');
            }
            
            // Maintain the module filter if present
            const moduleFilter = moduleSelector.getModule();
            if (moduleFilter) {
                url.searchParams.set('module', moduleFilter);
            }
            
            window.location.href = url.toString();
        });
    });
});
</script>
</body>
</html>
