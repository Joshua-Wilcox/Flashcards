<!DOCTYPE html>
<html>
<head>
    <title>Leaderboard - Flashcards</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Added for mobile scaling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .leaderboard-table {
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .leaderboard-table th, .leaderboard-table td {
            vertical-align: middle;
        }
        .rank-badge {
            font-weight: bold;
            font-size: 1.2em;
        }
        .username-link {
            text-decoration: none;
            color: #0d6efd;
        }
        .username-link:hover {
            text-decoration: underline;
        }
        .sort-btn {
            border: none;
            background: none;
            color: #0d6efd;
            font-weight: bold;
            cursor: pointer;
            padding: 0 4px;
        }
        .sort-btn.active {
            text-decoration: underline;
        }
        .sort-arrow {
            font-size: 0.9em;
        }
        footer {
            margin-top: 40px;
            padding: 10px 0;
        }
        @media (max-width: 768px) {
            .container {
                padding-left: 4px;
                padding-right: 4px;
            }
            .leaderboard-table th, .leaderboard-table td {
                font-size: 1em;
                padding: 8px 4px;
            }
            .rank-badge {
                font-size: 1em;
            }
            h1 {
                font-size: 1.5rem;
            }
        }
        @media (max-width: 576px) {
            .leaderboard-table th, .leaderboard-table td {
                font-size: 0.95em;
                padding: 6px 2px;
            }
            .rank-badge {
                font-size: 0.95em;
            }
            .table-responsive {
                font-size: 0.95em;
            }
        }
        #module-pills-container {
            scrollbar-width: thin;
            scrollbar-color: #0d6efd #e9ecef;
            padding-bottom: 4px;
        }
        #module-pills-container::-webkit-scrollbar {
            height: 6px;
        }
        #module-pills-container::-webkit-scrollbar-thumb {
            background: #0d6efd;
            border-radius: 4px;
        }
        .module-pill.active, .module-pill:active, .module-pill:focus {
            background-color: #0d6efd !important;
            color: #fff !important;
            border-color: #0d6efd !important;
        }
        .navbar-nav .nav-link {
            border-radius: 999px !important;
            padding: 8px 22px !important;
            margin-left: 6px;
            margin-right: 6px;
            font-weight: 600;
            transition: background 0.15s, color 0.15s, box-shadow 0.15s, transform 0.15s;
            background: #f8f9fa !important;
            color: #444 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            position: relative;
            z-index: 1;
        }
        .navbar-nav .nav-link:hover, .navbar-nav .nav-link:focus {
            background: #e2e6ea !important;
            color: #222 !important;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transform: scale(1.04);
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
            <div class="container-fluid">
                <span class="navbar-brand">Flashcards</span>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="{{ url_for('index') }}">Back to Flashcards</a>
                    {% if session.user_id %}
                        <a class="nav-link" href="{{ url_for('stats') }}">My Stats</a>
                        <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                    {% else %}
                        <a class="nav-link" href="{{ url_for('login') }}">Login with Discord</a>
                    {% endif %}
                </div>
            </div>
        </nav>
        <h1 class="text-center mb-4">Leaderboard</h1>
        <!-- Module filter pills -->
        <div class="mb-3">
            <div class="d-flex flex-nowrap overflow-auto" id="module-pills-container" style="gap: 8px;">
                {% for module in modules %}
                <button class="btn btn-outline-primary module-pill{% if active_module == module %} active{% endif %}" 
                        style="border-radius: 999px; min-width: 120px; white-space: nowrap;"
                        data-module="{{ module }}">
                    {{ module }}
                </button>
                {% endfor %}
            </div>
        </div>
        <div class="table-responsive">
            <table class="table leaderboard-table table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Rank</th>
                        <th>User</th>
                        <th>
                            <button class="sort-btn{% if sort == 'correct_answers' %} active{% endif %}" onclick="window.location='?sort=correct_answers&order={{ 'asc' if sort == 'correct_answers' and order == 'desc' else 'desc' }}{% if active_module %}&module={{ active_module }}{% endif %}'">Correct
                                {% if sort == 'correct_answers' %}<span class="sort-arrow">{{ '↑' if order == 'asc' else '↓' }}</span>{% endif %}
                            </button>
                        </th>
                        <th>
                            <button class="sort-btn{% if sort == 'total_answers' %} active{% endif %}" onclick="window.location='?sort=total_answers&order={{ 'asc' if sort == 'total_answers' and order == 'desc' else 'desc' }}{% if active_module %}&module={{ active_module }}{% endif %}'">Total
                                {% if sort == 'total_answers' %}<span class="sort-arrow">{{ '↑' if order == 'asc' else '↓' }}</span>{% endif %}
                            </button>
                        </th>
                        <th>
                            <button class="sort-btn{% if sort == 'accuracy' %} active{% endif %}" onclick="window.location='?sort=accuracy&order={{ 'asc' if sort == 'accuracy' and order == 'desc' else 'desc' }}{% if active_module %}&module={{ active_module }}{% endif %}'">Accuracy
                                {% if sort == 'accuracy' %}<span class="sort-arrow">{{ '↑' if order == 'asc' else '↓' }}</span>{% endif %}
                            </button>
                        </th>
                        <th>
                            <button class="sort-btn{% if sort == 'current_streak' %} active{% endif %}" onclick="window.location='?sort=current_streak&order={{ 'asc' if sort == 'current_streak' and order == 'desc' else 'desc' }}{% if active_module %}&module={{ active_module }}{% endif %}'">Streak
                                {% if sort == 'current_streak' %}<span class="sort-arrow">{{ '↑' if order == 'asc' else '↓' }}</span>{% endif %}
                            </button>
                        </th>
                        <th>
                            <button class="sort-btn{% if sort == 'last_answer_time' %} active{% endif %}" onclick="window.location='?sort=last_answer_time&order={{ 'asc' if sort == 'last_answer_time' and order == 'desc' else 'desc' }}{% if active_module %}&module={{ active_module }}{% endif %}'">Last Answered
                                {% if sort == 'last_answer_time' %}<span class="sort-arrow">{{ '↑' if order == 'asc' else '↓' }}</span>{% endif %}
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in leaderboard %}
                    <tr>
                        <td class="rank-badge">{{ loop.index }}</td>
                        <td>
                            <a class="username-link" href="{{ url_for('user_stats', user_id=user['user_id']) }}">
                                {{ user['username'] }}
                            </a>
                        </td>
                        <td>{{ user['correct_answers'] }}</td>
                        <td>{{ user['total_answers'] }}</td>
                        <td>
                            {% if user['total_answers'] > 0 %}
                                {{ "%.1f"|format(user['accuracy'] * 100) }}%
                            {% else %}
                                0%
                            {% endif %}
                        </td>
                        <td>
                            {% if active_module %}
                                {{ user['current_streak'] or 0 }}
                            {% else %}
                                {{ user['current_streak'] or 0 }}
                            {% endif %}
                        </td>
                        <td><span class="last-answered" data-timestamp="{{ user['last_answer_time'] or '' }}"></span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <footer class="text-center">
            <p>made with ❤️ by <a href="https://github.com/joshua-wilcox">Josh Wilcox</a></p>
            <p>websites are not free! if this has helped you more than a coffee, consider <a href="https://buymeacoffee.com/jmwcx">supporting</a></p>
        </footer>
    </div>
<script>
function formatRelativeTime(ts) {
    if (!ts) return "Never";
    const now = Math.floor((new Date()).getTime() / 1000);
    let diff = now - ts;
    if (diff < 60) return "Just now";
    const units = [
        { name: "year",   secs: 31536000 },
        { name: "month",  secs: 2592000 },
        { name: "day",    secs: 86400 },
        { name: "hour",   secs: 3600 },
        { name: "minute", secs: 60 }
    ];
    for (const unit of units) {
        if (diff >= unit.secs) {
            const value = Math.floor(diff / unit.secs);
            if (window.Intl && Intl.RelativeTimeFormat) {
                const rtf = new Intl.RelativeTimeFormat('en', { numeric: 'auto' });
                return rtf.format(-value, unit.name);
            } else {
                return value + ' ' + unit.name + (value !== 1 ? 's' : '') + ' ago';
            }
        }
    }
    return "Just now";
}
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.last-answered').forEach(function(el) {
        const ts = el.getAttribute('data-timestamp');
        if (ts && !isNaN(ts)) {
            el.textContent = formatRelativeTime(Number(ts));
        } else {
            el.textContent = "Never";
        }
    });
    // Module pill filter logic
    document.querySelectorAll('.module-pill').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const module = btn.getAttribute('data-module');
            const url = new URL(window.location.href);
            if (btn.classList.contains('active')) {
                url.searchParams.delete('module');
            } else {
                url.searchParams.set('module', module);
            }
            window.location = url.toString();
        });
    });
});
</script>
</body>
</html>
