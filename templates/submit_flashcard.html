<!DOCTYPE html>
<html>
<head>
    <title>Submit a Flashcard - Flashcards</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style-index.css') }}">
    <style>
        /* Unique styles for this page only */
        .submit-card { max-width: 800px; margin: 40px auto; box-shadow: 0 4px 16px rgba(0,0,0,0.08); border-radius: 12px; }
        .welcome-title { font-size: 2.2rem; font-weight: 700; color: #0d6efd; }
        .welcome-desc { font-size: 1.1rem; color: #555; margin-top: 10px; }
        .form-label { font-weight: 500; }
        .mini-input { max-width: 100%; }
        @media (max-width: 900px) { .submit-card { max-width: 98vw; } }
        /* Suggestions, tags, and other unique styles remain here */
        .suggestion-container { position: relative; }
        .suggestions-dropdown { position: absolute; width: 100%; max-height: 200px; overflow-y: auto; z-index: 1000; background: white; border: 1px solid #ced4da; border-radius: 0 0 0.25rem 0.25rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: none; }
        .suggestion-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .suggestion-item:hover, .suggestion-item.active { background-color: #f8f9fa; }
        .create-new-item { padding: 8px 12px; background-color: #e7f3ff; color: #0d6efd; font-weight: 500; border-bottom: 1px solid #d1e6ff; }
        .create-new-item:hover { background-color: #d1e6ff; }
        .suggestion-count { float: right; color: #6c757d; font-size: 0.85em; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .tag-item { background-color: #e7f3ff; color: #0d6efd; padding: 4px 10px; border-radius: 20px; }
        .tag-remove { margin-left: 6px; cursor: pointer; font-weight: bold; }
        .tag-add-container { display: flex; margin-top: 8px; }
        .tag-input { flex-grow: 1; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .tag-add-btn { border-top-left-radius: 0; border-bottom-left-radius: 0; }
        .disabled-field { background-color: #e9ecef; opacity: 0.65; cursor: not-allowed; }
        .form-sequence-container { position: relative; }
        #tags-error { color: #dc3545; font-size: 0.875em; margin-top: 0.25rem; display: none; }
        
        /* Distractor submission styles */
        .ai-prompt-section { 
            background: #f8f9fa; 
            border: 1px solid #e9ecef; 
            border-radius: 8px; 
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .ai-prompt-header { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
            border-bottom: 1px solid #dee2e6; 
            padding: 15px 20px; 
            border-radius: 8px 8px 0 0; 
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .ai-prompt-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        .ai-prompt-content { 
            padding: 20px; 
            font-size: 0.9rem; 
            line-height: 1.6; 
        }
        .human-preferred { 
            color: #6f42c1; 
            font-weight: 600; 
        }
        .ai-prompt-box {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .prompt-header-text {
            color: #495057;
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .ai-prompt-section .list-unstyled li {
            margin-bottom: 8px;
            padding-left: 0;
        }
        .ai-prompt-section .list-unstyled li strong {
            color: #495057;
        }
        .chatgpt-btn {
            border: 1.5px solid #10a37f !important;
            background: #f0fdf4 !important;
            color: #10a37f !important;
            font-weight: 600;
            font-size: 1.07em;
            padding: 8px 22px;
            border-radius: 999px !important;
            box-shadow: 0 2px 8px rgba(16, 163, 127, 0.08);
            transition: background 0.13s, color 0.13s, border 0.13s;
        }
        .chatgpt-btn:hover, .chatgpt-btn:focus {
            background: #dcfce7 !important;
            color: #059669 !important;
            border-color: #10a37f !important;
        }
        .perplexity-btn {
            border: 1.5px solid #00b4d8 !important;
            background: #f0f9ff !important;
            color: #00b4d8 !important;
            font-weight: 600;
            font-size: 1.07em;
            padding: 8px 22px;
            border-radius: 999px !important;
            box-shadow: 0 2px 8px rgba(0, 180, 216, 0.08);
            transition: background 0.13s, color 0.13s, border 0.13s;
        }
        .perplexity-btn:hover, .perplexity-btn:focus {
            background: #e0f2fe !important;
            color: #0288d1 !important;
            border-color: #00b4d8 !important;
        }
        .claude-btn {
            border: 1.5px solid #d97706 !important;
            background: #fffbeb !important;
            color: #d97706 !important;
            font-weight: 600;
            font-size: 1.07em;
            padding: 8px 22px;
            border-radius: 999px !important;
            box-shadow: 0 2px 8px rgba(217, 119, 6, 0.08);
            transition: background 0.13s, color 0.13s, border 0.13s;
        }
        .claude-btn:hover, .claude-btn:focus {
            background: #fef3c7 !important;
            color: #b45309 !important;
            border-color: #d97706 !important;
        }
        .copy-btn {
            border: 1.5px solid #6b7280 !important;
            background: #f9fafb !important;
            color: #6b7280 !important;
            font-weight: 600;
            font-size: 1.07em;
            padding: 8px 22px;
            border-radius: 999px !important;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.08);
            transition: background 0.13s, color 0.13s, border 0.13s;
        }
        .copy-btn:hover, .copy-btn:focus {
            background: #f3f4f6 !important;
            color: #374151 !important;
            border-color: #6b7280 !important;
        }
        .ai-button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }
        @media (max-width: 576px) {
            .ai-button-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
        <div class="container mt-4">
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
                <div class="container-fluid">
                    <span class="navbar-brand">Flashcards</span>
                    <div class="navbar-nav ms-auto">
                        <a class="nav-link" href="{{ url_for('main.index') }}">Back to Flashcards</a>
                        <a class="nav-link" href="{{ url_for('user.leaderboard') }}">Leaderboard</a>
                        <a class="nav-link" href="{{ url_for('user.stats') }}">My Stats</a>
                        <a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a>
                    </div>
                </div>
            </nav>
            <div class="submit-card card p-4">
                <div class="text-center mb-3">
                    <div class="welcome-title">Submit a Flashcard</div>
                    <div class="welcome-desc">Contribute your own flashcard for review! Please fill in all required fields.</div>
                </div>
                {% with messages = get_flashed_messages() %}
                  {% if messages %}
                    <div class="alert alert-info" role="alert">
                      {{ messages[0] }}
                    </div>
                  {% endif %}
                {% endwith %}
                <form id="flashcard-form" method="post" autocomplete="off">
                    <div class="mb-3">
                        <label for="question" class="form-label">Question <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="question" name="question" rows="3" required>{{ '' if clear_fields else prev_question if prev_question is defined else '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="answer" class="form-label">Answer <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="answer" name="answer" rows="2" required>{{ '' if clear_fields else prev_answer if prev_answer is defined else '' }}</textarea>
                    </div>
                    
                    <!-- Sequential form flow container -->
                    <div class="form-sequence-container">
                        <!-- Step 1: Module -->
                        <div class="mb-3">
                            <label for="module" class="form-label">Module <span class="text-danger">*</span></label>
                            <select class="form-select" id="module" name="module" required>
                                <option value="">Select Module</option>
                                {% for m in modules %}
                                    <option value="{{ m }}" {% if selected_module == m %}selected{% endif %}>{{ m }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Step 2: Topic with suggestions -->
                        <div class="mb-3">
                            <label for="topic" class="form-label">Topic <span class="text-danger">*</span></label>
                            <div class="suggestion-container">
                                <input type="text" class="form-control" id="topic" name="topic" 
                                       maxlength="64" placeholder="Choose a topic..." 
                                       value="{{ prev_topic if prev_topic is defined else '' }}" required disabled>
                                <div class="suggestions-dropdown" id="topic-suggestions"></div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Subtopic with suggestions -->
                        <div class="mb-3">
                            <label for="subtopic" class="form-label">Subtopic <span class="text-danger">*</span></label>
                            <div class="suggestion-container">
                                <input type="text" class="form-control" id="subtopic" name="subtopic" 
                                       maxlength="64" placeholder="Choose a subtopic..." 
                                       value="{{ prev_subtopic if prev_subtopic is defined else '' }}" required disabled>
                                <div class="suggestions-dropdown" id="subtopic-suggestions"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 4: Tags - multiple with "add tag" pill -->
                    <div class="mb-3">
                        <label class="form-label">Tags <span class="text-danger">*</span> <small class="text-muted">(at least 3 required)</small></label>
                        <div class="tag-add-container">
                            <input type="text" class="form-control tag-input" id="tag-input" 
                                   placeholder="Enter a tag..." maxlength="32" disabled>
                            <button type="button" class="btn btn-primary tag-add-btn" id="add-tag-btn" disabled>Add Tag</button>
                        </div>
                        <div class="suggestions-dropdown" id="tag-suggestions"></div>
                        <div class="tag-container" id="tag-container"></div>
                        <div id="tags-error">Please add at least 3 tags</div>
                        <input type="hidden" id="tags" name="tags" required>
                    </div>
                    
                    <!-- Step 5: Submit Distractors - Hidden dropdown section -->
                    <div class="mb-3" id="distractor-section" style="display: none;">
                        <div class="ai-prompt-section">
                            <div class="ai-prompt-header" data-bs-toggle="collapse" data-bs-target="#distractorDropdown" aria-expanded="false" aria-controls="distractorDropdown">
                                <h6 class="mb-0 d-flex align-items-center">
                                    <span class="human-preferred">Submit Distractors</span> 
                                    <span class="ms-2 text-muted">(optional - help improve the question)</span>
                                    <small class="text-muted ms-auto">(click to expand)</small>
                                </h6>
                            </div>
                            <div class="collapse" id="distractorDropdown">
                                <div class="ai-prompt-content">
                                    <p class="text-muted mb-3">Help improve this question by suggesting plausible wrong answers that are challenging but clearly incorrect.</p>
                                    
                                    <!-- AI Prompt Suggestion Section -->
                                    <div class="ai-prompt-section mb-3">
                                        <div class="ai-prompt-header" data-bs-toggle="collapse" data-bs-target="#aiPromptCollapse" aria-expanded="false" aria-controls="aiPromptCollapse">
                                            <h6 class="mb-0 d-flex align-items-center">
                                                <i class="bi bi-lightbulb me-2" style="color: #ffc107;"></i>
                                                <span class="human-preferred">Human responses preferred!</span> 
                                                <span class="ms-2 text-muted">But if you need AI assistance...</span>
                                                <small class="text-muted ms-auto">(click to expand)</small>
                                            </h6>
                                        </div>
                                        <div class="collapse" id="aiPromptCollapse">
                                            <div class="ai-prompt-content">
                                                <p class="human-preferred mb-3">We strongly encourage human-generated distractors as they tend to be more effective and creative. However, if you need AI assistance, here's a suggested prompt:</p>
                                                <div class="ai-prompt-box">
                                                    <div class="prompt-header-text">Suggested AI Prompt</div>
                                                    <hr class="my-2" style="opacity: 0.3;">
                                                    <p class="mb-3"><strong>You will be provided with a single flashcard object containing a 'Question' and its correct 'Answer'. Your task is to generate four (4) incorrect distractor answers for this flashcard.</strong></p>
                                                    <p class="mb-3"><strong>These distractors must strictly adhere to the following rules:</strong></p>
                                                    <ul class="list-unstyled mb-0">
                                                        <li class="mb-3">• <strong>Context-Dependent & Ambiguous in Isolation:</strong> Each distractor, when read on its own (without the associated 'Question'), should be ambiguous, incomplete, or not make full sense. It should only appear as a plausible (though incorrect) response when considered as an answer to the original 'Question' from the provided flashcard.</li>
                                                        <li class="mb-3">• <strong>No Hints or Question Referencing:</strong> Distractors must NOT contain any words, phrases, or concepts directly from the 'Question' that would give away the context or make the distractor obviously related to that specific question if seen in a list of other potential answers. The distractor should stand alone as a short phrase or term.</li>
                                                        <li class="mb-3">• <strong>Plausible but Definitely Incorrect:</strong> Distractors should be designed to seem like reasonable potential answers to the original 'Question'. However, each distractor must be clearly and definitively incorrect as an answer to the original 'Question'.</li>
                                                        <li class="mb-3">• <strong>Format & Style Consistency:</strong> Distractors must be in simple plaintext. Their style, length, and complexity should be similar to the provided correct 'Answer'. Avoid any special formatting, LaTeX, or complex mathematical notation.</li>
                                                        <li class="mb-0">• <strong>Uniqueness:</strong> Each generated distractor should be unique from the correct 'Answer' and from the other distractors you generate for the same question-answer pair.</li>
                                                    </ul>
                                                    <hr class="my-3" style="opacity: 0.3;">
                                                    <div class="prompt-header-text">Your Flashcard Data:</div>
                                                    <div class="bg-light p-2 rounded mt-2" style="font-family: monospace; font-size: 0.85rem;" id="flashcard-data-display">
                                                        <strong>Question:</strong> <span id="question-preview">Your question will appear here</span><br>
                                                        <strong>Answer:</strong> <span id="answer-preview">Your answer will appear here</span>
                                                    </div>
                                                    <div class="mt-3 text-center">
                                                        <div class="ai-button-grid">
                                                            <button type="button" class="btn chatgpt-btn" onclick="openInChatGPT()">
                                                                <i class="bi bi-robot me-1"></i>Open in ChatGPT
                                                            </button>
                                                            <button type="button" class="btn perplexity-btn" onclick="openInPerplexity()">
                                                                <i class="bi bi-search me-1"></i>Open in Perplexity
                                                            </button>
                                                            <button type="button" class="btn claude-btn" onclick="openInClaude()">
                                                                <i class="bi bi-chat-dots me-1"></i>Open in Claude
                                                            </button>
                                                            <button type="button" class="btn copy-btn" onclick="copyToClipboard()">
                                                                <i class="bi bi-clipboard me-1"></i>Copy to Clipboard
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Distractor Form Fields -->
                                    <div class="mb-3">
                                        <label class="form-label">Suggested Distractors <small class="text-muted">(wrong answers that are plausible but incorrect)</small></label>
                                        <p class="text-muted small">You can submit 1-4 distractors. Good distractors are wrong but believable answers that test understanding.</p>
                                        
                                        <div class="mb-2">
                                            <label for="distractor_0" class="form-label">Distractor 1:</label>
                                            <textarea class="form-control" id="distractor_0" name="distractor_0" rows="2" placeholder="Enter a plausible wrong answer..."></textarea>
                                        </div>
                                        <div class="mb-2">
                                            <label for="distractor_1" class="form-label">Distractor 2:</label>
                                            <textarea class="form-control" id="distractor_1" name="distractor_1" rows="2" placeholder="Enter a plausible wrong answer..."></textarea>
                                        </div>
                                        <div class="mb-2">
                                            <label for="distractor_2" class="form-label">Distractor 3:</label>
                                            <textarea class="form-control" id="distractor_2" name="distractor_2" rows="2" placeholder="Enter a plausible wrong answer..."></textarea>
                                        </div>
                                        <div class="mb-2">
                                            <label for="distractor_3" class="form-label">Distractor 4:</label>
                                            <textarea class="form-control" id="distractor_3" name="distractor_3" rows="2" placeholder="Enter a plausible wrong answer..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100">Submit for Review</button>
                </form>
            </div>
        </div>
        <footer class="text-center">
            <p>made with ❤️ by <a href="https://github.com/joshua-wilcox">Josh Wilcox</a></p>
        </footer>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            let selectedTags = [];
            
            // Load saved tags if any (from previous form submission)
            {% if prev_tags is defined and prev_tags %}
                {% if clear_fields %}
                    selectedTags = [];
                {% else %}
                    selectedTags = "{{ prev_tags }}".split(',').map(tag => tag.trim()).filter(tag => tag);
                    updateTagsDisplay();
                {% endif %}
            {% endif %}
            
            // STEP 1: Module selection enables topic field
            $('#module').on('change', function() {
                const module = $(this).val();
                if (module) {
                    $('#topic').prop('disabled', false).removeClass('disabled-field');
                    $('#subtopic').prop('disabled', true).addClass('disabled-field').val('');
                    $('#tag-input, #add-tag-btn').prop('disabled', true).addClass('disabled-field');
                    selectedTags = [];
                    updateTagsDisplay();
                } else {
                    $('#topic, #subtopic, #tag-input, #add-tag-btn')
                        .prop('disabled', true)
                        .addClass('disabled-field');
                    $('#topic, #subtopic').val('');
                }
            });
            
            // Initialize fields based on current module selection
            if ($('#module').val()) {
                $('#topic').prop('disabled', false).removeClass('disabled-field');
                if ($('#topic').val()) {
                    $('#subtopic').prop('disabled', false).removeClass('disabled-field');
                    if ($('#subtopic').val()) {
                        $('#tag-input, #add-tag-btn').prop('disabled', false).removeClass('disabled-field');
                    }
                }
            }
            
            // TOPIC SUGGESTIONS
            $('#topic').on('focus input', function() {
                const module = $('#module').val();
                const query = $(this).val().trim();
                
                if (!module) {
                    return;
                }
                
                $.ajax({
                    url: '/api/suggest/topics',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ module: module, query: query }),
                    success: function(response) {
                        const suggestions = response.suggestions;
                        let html = `<div class="create-new-item" data-value="${query}">+ Create topic "${query}"</div>`;
                        
                        suggestions.forEach(suggestion => {
                            html += `<div class="suggestion-item" data-value="${suggestion.name}">
                                ${suggestion.name}
                                <span class="suggestion-count">${suggestion.count} questions</span>
                            </div>`;
                        });
                        
                        $('#topic-suggestions').html(html).show();
                    }
                });
            });
            
            // SUBTOPIC SUGGESTIONS
            $('#subtopic').on('focus input', function() {
                const module = $('#module').val();
                const topic = $('#topic').val();
                const query = $(this).val().trim();
                
                if (!module || !topic) {
                    return;
                }
                
                $.ajax({
                    url: '/api/suggest/subtopics',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ module: module, topic: topic, query: query }),
                    success: function(response) {
                        const suggestions = response.suggestions;
                        let html = `<div class="create-new-item" data-value="${query}">+ Create subtopic "${query}"</div>`;
                        
                        suggestions.forEach(suggestion => {
                            html += `<div class="suggestion-item" data-value="${suggestion.name}">
                                ${suggestion.name}
                                <span class="suggestion-count">${suggestion.count} questions</span>
                            </div>`;
                        });
                        
                        $('#subtopic-suggestions').html(html).show();
                    }
                });
            });
            
            // TAG SUGGESTIONS
            $('#tag-input').on('focus input', function(e) {
                e.stopPropagation(); // Prevent event from bubbling up
                const module = $('#module').val();
                const topic = $('#topic').val().trim();
                const subtopic = $('#subtopic').val().trim();
                const query = $(this).val().trim();
                
                if (!module || !topic || !subtopic) {
                    return;
                }
                
                $.ajax({
                    url: '/api/suggest/tags',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ 
                        module: module, 
                        topic: topic, 
                        subtopic: subtopic,
                        query: query 
                    }),
                    success: function(response) {
                        const suggestions = response.suggestions;
                        let html = `<div class="create-new-item" data-value="${query}">+ Create tag "${query}"</div>`;
                        
                        suggestions.forEach(suggestion => {
                            // Skip suggestions for tags already selected
                            if (selectedTags.includes(suggestion.name)) {
                                return;
                            }
                            
                            html += `<div class="suggestion-item" data-value="${suggestion.name}">
                                ${suggestion.name}
                                <span class="suggestion-count">${suggestion.count} questions</span>
                            </div>`;
                        });
                        
                        $('#tag-suggestions').html(html).show();
                    }
                });
            });
            
            // Handle suggestion selection for topic
            $(document).on('click', '#topic-suggestions .suggestion-item, #topic-suggestions .create-new-item', function() {
                const value = $(this).data('value');
                $('#topic').val(value);
                $('#topic-suggestions').hide();
                
                // Enable subtopic field now that topic is selected
                $('#subtopic').prop('disabled', false).removeClass('disabled-field');
            });
            
            // Handle suggestion selection for subtopic
            $(document).on('click', '#subtopic-suggestions .suggestion-item, #subtopic-suggestions .create-new-item', function() {
                const value = $(this).data('value');
                $('#subtopic').val(value);
                $('#subtopic-suggestions').hide();
                
                // Enable tags field now that subtopic is selected
                $('#tag-input, #add-tag-btn').prop('disabled', false).removeClass('disabled-field');
            });
            
            // Handle suggestion selection for tags
            $(document).on('click', '#tag-suggestions .suggestion-item, #tag-suggestions .create-new-item', function(e) {
                e.stopPropagation(); // Prevent event from bubbling up
                const value = $(this).data('value');
                $('#tag-input').val('');
                $('#tag-suggestions').hide();
                
                // Add the tag if it's not already in the list
                if (!selectedTags.includes(value)) {
                    selectedTags.push(value);
                    updateTagsDisplay();
                }
            });
            
            // Add tag button click handler
            $('#add-tag-btn').on('click', function() {
                const value = $('#tag-input').val().trim();
                if (value && !selectedTags.includes(value)) {
                    selectedTags.push(value);
                    $('#tag-input').val('');
                    updateTagsDisplay();
                }
            });
            
            // Enter key in tag input also adds the tag
            $('#tag-input').on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    e.preventDefault();
                    const value = $(this).val().trim();
                    if (value && !selectedTags.includes(value)) {
                        selectedTags.push(value);
                        $(this).val('');
                        updateTagsDisplay();
                    }
                }
            });
            
            // Remove tag when clicking the X
            $(document).on('click', '.tag-remove', function() {
                const tagToRemove = $(this).data('tag');
                selectedTags = selectedTags.filter(tag => tag !== tagToRemove);
                updateTagsDisplay();
            });
            
            // Prevent dropdown from closing when clicking inside it
            $(document).on('click', '#tag-suggestions', function(e) {
                e.stopPropagation();
            });
            
            // Hide suggestion dropdowns when clicking outside specific elements
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.tag-add-container, #tag-suggestions').length) {
                    $('#tag-suggestions').hide();
                }
                if (!$(e.target).closest('#topic, #topic-suggestions').length) {
                    $('#topic-suggestions').hide();
                }
                if (!$(e.target).closest('#subtopic, #subtopic-suggestions').length) {
                    $('#subtopic-suggestions').hide();
                }
            });
            
            // Handle form submission
            $('#flashcard-form').on('submit', function(e) {
                // Validate at least 3 tags
                if (selectedTags.length < 3) {
                    e.preventDefault();
                    $('#tags-error').show();
                    return false;
                }
                
                // Set the tags hidden input before submitting
                $('#tags').val(selectedTags.join(', '));
                return true;
            });

            // Function to update the tags display
            function updateTagsDisplay() {
                // Update the visual representation of tags
                let html = '';
                selectedTags.forEach(tag => {
                    html += `
                        <div class="tag-item">
                            ${tag}
                            <span class="tag-remove" data-tag="${tag}">×</span>
                        </div>
                    `;
                });
                $('#tag-container').html(html);
                
                // Update the hidden input value
                $('#tags').val(selectedTags.join(', '));
                
                // Update validation state
                if (selectedTags.length >= 3) {
                    $('#tags-error').hide();
                } else {
                    $('#tags-error').show();
                }
                
                // Check if distractor section should be shown
                checkDistractorSectionVisibility();
            }
            
            // Function to check if all form fields are completed and show distractor section
            function checkDistractorSectionVisibility() {
                const question = $('#question').val().trim();
                const answer = $('#answer').val().trim();
                const module = $('#module').val();
                const topic = $('#topic').val().trim();
                const subtopic = $('#subtopic').val().trim();
                const hasEnoughTags = selectedTags.length >= 3;
                
                if (question && answer && module && topic && subtopic && hasEnoughTags) {
                    $('#distractor-section').show();
                    updateFlashcardPreview();
                } else {
                    $('#distractor-section').hide();
                }
            }
            
            // Function to update the flashcard preview in the AI prompt
            function updateFlashcardPreview() {
                const question = $('#question').val().trim();
                const answer = $('#answer').val().trim();
                $('#question-preview').text(question || 'Your question will appear here');
                $('#answer-preview').text(answer || 'Your answer will appear here');
            }
            
            // Add event listeners to trigger distractor section visibility check
            $('#question, #answer').on('input', checkDistractorSectionVisibility);
            $('#module').on('change', checkDistractorSectionVisibility);
            $('#topic, #subtopic').on('input', checkDistractorSectionVisibility);
            
            // AI Integration Functions
            function getPromptText() {
                const question = $('#question').val().trim();
                const answer = $('#answer').val().trim();
                
                return `You will be provided with a single flashcard object containing a 'Question' and its correct 'Answer'. Your task is to generate four (4) incorrect distractor answers for this flashcard.

These distractors must strictly adhere to the following rules:

• Context-Dependent & Ambiguous in Isolation: Each distractor, when read on its own (without the associated 'Question'), should be ambiguous, incomplete, or not make full sense. It should only appear as a plausible (though incorrect) response when considered as an answer to the original 'Question' from the provided flashcard.

• No Hints or Question Referencing: Distractors must NOT contain any words, phrases, or concepts directly from the 'Question' that would give away the context or make the distractor obviously related to that specific question if seen in a list of other potential answers. The distractor should stand alone as a short phrase or term.

• Plausible but Definitely Incorrect: Distractors should be designed to seem like reasonable potential answers to the original 'Question'. However, each distractor must be clearly and definitively incorrect as an answer to the original 'Question'.

• Format & Style Consistency: Distractors must be in simple plaintext. Their style, length, and complexity should be similar to the provided correct 'Answer'. Avoid any special formatting, LaTeX, or complex mathematical notation.

• Uniqueness: Each generated distractor should be unique from the correct 'Answer' and from the other distractors you generate for the same question-answer pair.

Question: ${question}
Answer: ${answer}`;
            }
            
            window.openInChatGPT = function() {
                const prompt = getPromptText();
                const encodedPrompt = encodeURIComponent(prompt);
                const chatgptUrl = `https://chatgpt.com/?q=${encodedPrompt}`;
                window.open(chatgptUrl, '_blank');
            };
            
            window.openInPerplexity = function() {
                const prompt = getPromptText();
                const encodedPrompt = encodeURIComponent(prompt);
                const perplexityUrl = `https://www.perplexity.ai/search?q=${encodedPrompt}`;
                window.open(perplexityUrl, '_blank');
            };
            
            window.openInClaude = function() {
                const prompt = getPromptText();
                const encodedPrompt = encodeURIComponent(prompt);
                const claudeUrl = `https://claude.ai/new?q=${encodedPrompt}`;
                window.open(claudeUrl, '_blank');
            };
            
            window.copyToClipboard = function() {
                const prompt = getPromptText();
                navigator.clipboard.writeText(prompt).then(function() {
                    // Show success feedback
                    const btn = event.target.closest('.copy-btn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                }).catch(function(err) {
                    console.error('Could not copy text: ', err);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = prompt;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    const btn = event.target.closest('.copy-btn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                });
            };
            
            // Enhanced duplicate detection with debounce
            let duplicateCheckTimeout = null;
            
            function checkForDuplicates() {
                const question = $('#question').val().trim();
                const module = $('#module').val();
                
                if (!question || !module || question.length < 10) {
                    $('#duplicate-container').hide();
                    return;
                }
                
                $.ajax({
                    url: '/api/check_duplicates',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ 
                        question: question,
                        module: module
                    }),
                    success: function(response) {
                        const duplicates = response.duplicates;
                        if (duplicates && duplicates.length > 0) {
                            // Populate duplicate list
                            const $list = $('#duplicate-list');
                            $list.empty();
                            
                            duplicates.forEach(dup => {
                                // Convert similarity score to percentage
                                const similarityPct = Math.round(dup.similarity * 100);
                                
                                // Determine color based on similarity
                                let bgClass = 'bg-light';
                                if (similarityPct >= 70) {
                                    bgClass = 'bg-danger text-white';
                                } else if (similarityPct >= 50) {
                                    bgClass = 'bg-warning';
                                } else if (similarityPct >= 30) {
                                    bgClass = 'bg-info bg-opacity-25';
                                }
                                
                                $list.append(`
                                    <div class="list-group-item ${bgClass}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="fw-bold">${dup.question}</div>
                                            <span class="badge bg-primary rounded-pill">${similarityPct}% match</span>
                                        </div>
                                        <small class="text-${similarityPct >= 70 && bgClass === 'bg-danger text-white' ? 'light' : 'muted'}">Answer: ${dup.answer}</small>
                                    </div>
                                `);
                            });
                            
                            $('#duplicate-container').show();
                        } else {
                            $('#duplicate-container').hide();
                        }
                    }
                });
            }
            
            // Run duplicate check when user has finished editing the question field (not on every keystroke)
            $('#question').on('blur', function() {
                clearTimeout(duplicateCheckTimeout);
                duplicateCheckTimeout = setTimeout(checkForDuplicates, 500);
            });
            
            // Run when module is changed and question is filled
            $('#module').on('change', function() {
                if ($('#question').val().trim().length > 10) {
                    clearTimeout(duplicateCheckTimeout);
                    duplicateCheckTimeout = setTimeout(checkForDuplicates, 500);
                }
            });
        });
    </script>
</body>
</html>
