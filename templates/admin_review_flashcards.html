<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style-index.css') }}">
    <style>
        /* Unique styles for this page only */
        .content-wrapper { min-height: 100vh; display: flex; flex-direction: column; }
        .table-responsive { margin-top: 24px; }
    </style>
</head>
<body>
    <div class="content-wrapper">
        <div class="container mt-4">
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
                <div class="container-fluid">
                    <span class="navbar-brand">Admin Dashboard</span>
                    <div class="navbar-nav ms-auto">
                        <a class="nav-link" href="{{ url_for('main.index') }}">Back to Flashcards</a>
                        <a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a>
                    </div>
                </div>
            </nav>
            <h2>Submitted Flashcards for Review</h2>
            {% with messages = get_flashed_messages() %}
              {% if messages %}
                <div class="alert alert-info" role="alert">
                  {{ messages[0] }}
                </div>
              {% endif %}
            {% endwith %}
            <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Submitted By</th>
                            <th>Submitted At</th>
                            <th>Module</th>
                            <th>Review</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sub in submissions %}
                        <tr>
                            <td>{{ sub['id'] }}</td>
                            <td>{{ sub['username'] or sub['user_id'] }}</td>
                            <td><span class="submitted-at" data-timestamp="{{ sub['timestamp'] }}"></span></td>
                            <td>{{ sub['module'] }}</td>
                            <td>
                                <a class="btn btn-primary btn-sm" href="{{ url_for('admin.admin_review_flashcard', submission_id=sub['id']) }}">Review</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center">No submissions pending review.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Reported Questions Table -->
            <div class="table-responsive mt-5">
                <h3>Reported Questions</h3>
                <table class="table table-bordered table-striped align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Reported By</th>
                            <th>Reported At</th>
                            <th>Question</th>
                            <th>Review</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rep in reports %}
                        <tr>
                            <td>{{ rep['id'] }}</td>
                            <td>{{ rep['username'] or rep['user_id'] }}</td>
                            <td><span class="reported-at" data-timestamp="{{ rep['timestamp'] }}"></span></td>
                            <td>{{ rep['question'][:64] }}{% if rep['question']|length > 64 %}...{% endif %}</td>
                            <td>
                                <a class="btn btn-warning btn-sm" href="{{ url_for('admin.admin_review_report', report_id=rep['id']) }}">Review</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center">No reports pending review.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Distractor Submissions Table -->
            <div class="table-responsive mt-5">
                <h3>Distractor Submissions</h3>
                <table class="table table-bordered table-striped align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Submitted By</th>
                            <th>Submitted At</th>
                            <th>Question</th>
                            <th>Distractor</th>
                            <th>Review</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for distractor in distractor_submissions %}
                        <tr>
                            <td>{{ distractor['id'] }}</td>
                            <td>{{ distractor['username'] or distractor['user_id'] }}</td>
                            <td><span class="distractor-submitted-at" data-timestamp="{{ distractor['timestamp'] }}"></span></td>
                            <td>{{ distractor['question'][:50] }}{% if distractor['question']|length > 50 %}...{% endif %}</td>
                            <td>{{ distractor['distractor_text'][:30] }}{% if distractor['distractor_text']|length > 30 %}...{% endif %}</td>
                            <td>
                                <a class="btn btn-primary btn-sm" href="{{ url_for('admin.admin_review_distractor', submission_id=distractor['id']) }}">Review</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center">No distractor submissions pending review.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- PDF Access Requests Table -->
            <div class="table-responsive mt-5">
                <h3>PDF Access Requests</h3>
                <div class="alert alert-warning mb-2" style="max-width:800px;">
                    <b>Note:</b> Please talk to Josh before approving PDF access requests. These are his notes and not for general distribution.
                </div>
                <table class="table table-bordered table-striped align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Message</th>
                            <th>Requested At</th>
                            <th>Review</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in pdf_requests %}
                        <tr>
                            <td>{{ req['id'] }}</td>
                            <td>{{ req['username'] or req['discord_id'] }}</td>
                            <td>{{ req['message'] or '' }}</td>
                            <td><span class="pdf-requested-at" data-timestamp="{{ req['timestamp'] }}"></span></td>
                            <td>
                                <a class="btn btn-info btn-sm" href="{{ url_for('admin.admin_review_pdf_request', request_id=req['id']) }}">Review</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center">No PDF access requests pending review.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <footer class="text-center">
            <p>made with ❤️ by <a href="https://github.com/joshua-wilcox">Josh Wilcox</a></p>
        </footer>
    </div>
    <script>
function formatRelativeTime(ts) {
    if (!ts) return "Never";
    const now = Math.floor(Date.now() / 1000);
    const localTs = ts - (new Date().getTimezoneOffset() * 60);
    let diff = now - localTs;
    if (diff < 60) return "Just now";
    const units = [
        { name: "year",   secs: 31536000 },
        { name: "month",  secs: 2592000 },
        { name: "day",    secs: 86400 },
        { name: "hour",   secs: 3600 },
        { name: "minute", secs: 60 }
    ];
    for (const unit of units) {
        if (diff >= unit.secs) {
            const value = Math.floor(diff / unit.secs);
            if (window.Intl && Intl.RelativeTimeFormat) {
                const rtf = new Intl.RelativeTimeFormat('en', { numeric: 'auto' });
                return rtf.format(-value, unit.name);
            } else {
                return value + ' ' + unit.name + (value !== 1 ? 's' : '') + ' ago';
            }
        }
    }
    return "Just now";
}
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.submitted-at').forEach(function(el) {
        const ts = el.getAttribute('data-timestamp');
        if (ts && !isNaN(ts)) {
            el.textContent = formatRelativeTime(Number(ts));
        } else {
            el.textContent = "Never";
        }
    });
    document.querySelectorAll('.reported-at').forEach(function(el) {
        const ts = el.getAttribute('data-timestamp');
        if (ts && !isNaN(ts)) {
            el.textContent = formatRelativeTime(Number(ts));
        } else {
            el.textContent = "Never";
        }
    });
    document.querySelectorAll('.distractor-submitted-at').forEach(function(el) {
        const ts = el.getAttribute('data-timestamp');
        if (ts && !isNaN(ts)) {
            el.textContent = formatRelativeTime(Number(ts));
        } else {
            el.textContent = "Never";
        }
    });
    document.querySelectorAll('.pdf-requested-at').forEach(function(el) {
        const ts = el.getAttribute('data-timestamp');
        if (ts && !isNaN(ts)) {
            el.textContent = formatRelativeTime(Number(ts));
        } else {
            el.textContent = "Never";
        }
    });
});
    </script>
</body>
</html>
